# 워커 전체 흐름 정리

이 문서는  
04-batch-worker 파트에서 구현한 **Node.js 워커의 전체 실행 흐름**을  
한 번에 정리한다.

개별 파일의 문법이나 세부 구현이 아니라,  
**“이 워커가 어떻게 시작해서 어떻게 끝나는지”** 를 설명하는 것이 목적이다.


---

## 워커 실행 한 줄 요약

```text
node src/worker.js 실행 →
환경 변수 로드 →
DB 연결 →
job 실행 →
성공/실패 판단 →
종료 코드 반환
```

---

## 전체 흐름 다이어그램 (텍스트)

```text
[운영자 / cron]
        |
        v
  node src/worker.js
        |
        v
  환경 변수 로드 (.env)
        |
        v
  DB 커넥션 풀 준비
        |
        v
  job 실행 (fetch_news)
        |
        v
  service 실행
        |
        v
  repository(SQL)
        |
        v
       DB
        |
        v
  정상 종료 (exit 0)
        |
       or
        |
  예외 발생
        |
        v
  실패 종료 (exit 1)
```

---

## 파일별 역할 정리

### 1. `src/worker.js`

**역할**

* 워커의 진입점(entry point)
* 전체 실행 흐름 제어
* 성공/실패를 종료 코드로 변환

**하지 않는 것**

* 비즈니스 로직
* SQL
* 데이터 가공

---

### 2. `src/jobs/fetch_news.job.js`

**역할**

* 하나의 작업 단위(job) 실행
* service 호출
* 실패 시 예외 전파

**하지 않는 것**

* DB 접근
* 흐름 제어
* 종료 판단

---

### 3. `src/services/news.service.js`

**역할**

* 업무 흐름과 정책 표현
* 반복/조건/판단
* repository 호출 순서 제어

**하지 않는 것**

* SQL
* 커넥션 관리
* 프로세스 제어

---

### 4. `src/repositories/news.repository.js`

**역할**

* SQL 작성 및 실행
* DB 결과 반환

**하지 않는 것**

* 업무 의미 해석
* 성공/실패 정책 판단

---

### 5. `src/db/pool.js`

**역할**

* DB 커넥션 풀 생성
* 워커 전체에서 공유되는 인프라 리소스

---

## 실패 흐름 정리

워커에서 실패는 다음 의미를 가진다.

* 예외가 발생했다
* 정상적인 작업을 완료하지 못했다
* 운영 환경에서 재시도 대상이다

실패 흐름:

```text
repository/service/job 중 에러 발생
  ↓
throw
  ↓
worker.js catch
  ↓
process.exit(1)
```

> 실패는 숨기지 않는다.  
> **종료 코드로 명확히 표현한다.**

---

## 성공 흐름 정리

```text
모든 job 정상 종료
  ↓
리소스 정리 (pool.end)
  ↓
process.exit(0)
```

---

## 이 구조의 장점

* 파일 하나만 봐도 역할이 명확
* 테스트 / 교체 / 확장에 유리
* 서버(Spring) 구조와 개념적으로 동일
* 운영 환경에서 예측 가능

---

## 이 문서에서 다루지 않는 것

* 중복 실행 방지 락
* 스케줄링(cron)
* 재시도 전략
* 성능 최적화

이 내용은 **구조가 고정된 이후 단계**에서 다룬다.

---

## 다음 단계

다음 문서에서는  
이 워커를 **운영 환경에서 안전하게 실행하기 위한 요소**를 추가한다.

→ [중복 실행 방지 락 구현](08-worker_lock.md)
